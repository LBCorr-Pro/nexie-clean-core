# GitHub Action para sincronizar o reposit√≥rio de desenvolvimento com o Clean Core
#
# O que este workflow faz:
# 1. √â acionado sempre que h√° um push na branch 'master' do reposit√≥rio de desenvolvimento (este).
# 2. Clona este reposit√≥rio (Dev).
# 3. Clona o reposit√≥rio 'nexie-clean-core' para uma pasta ao lado.
# 4. Executa o script 'promote-to-clean.sh' que copia apenas os arquivos limpos.
# 5. Se houver alguma altera√ß√£o no Clean Core, a Action faz o commit e o push automaticamente.

name: Distribute to Clean Core

on:
  push:
    branches:
      - master  # Corrigido de 'main' para 'master'

jobs:
  build-and-distribute:
    runs-on: ubuntu-latest  # Usa a vers√£o mais recente do Ubuntu

    steps:
      - name: 1. Checkout do Reposit√≥rio Dev (Nexie-REC)
        uses: actions/checkout@v3
        with:
          path: nexie-dev # Clona o c√≥digo para um subdiret√≥rio

      - name: 2. Checkout do Reposit√≥rio Clean Core
        uses: actions/checkout@v3
        with:
          repository: LBCorr-Pro/nexie-clean-core # SEU REPOSIT√ìRIO CLEAN CORE
          path: nexie-clean-core # Clona para um diret√≥rio ao lado
          token: ${{ secrets.GH_PAT }} # Token de acesso para poder fazer push

      - name: 3. Dar Permiss√£o e Executar o Script de Promo√ß√£o
        run: |
          # Navega para o diret√≥rio do dev-core
          cd nexie-dev
          
          # D√° permiss√£o de execu√ß√£o ao script
          chmod +x ./scripts/promote-to-clean.sh
          
          # Executa o script. O destino (../nexie-clean-core) j√° est√° correto.
          ./scripts/promote-to-clean.sh

      - name: 4. Fazer Commit e Push das Mudan√ßas para o Clean Core
        run: |
          cd nexie-clean-core
          
          # Configura o usu√°rio do Git para o commit
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'action-bot@github.com'
          
          # Adiciona, faz o commit e o push SOMENTE se houver mudan√ßas
          if [[ `git status --porcelain` ]]; then
            git add .
            git commit -m "chore: Sincroniza√ß√£o autom√°tica a partir do reposit√≥rio Dev"
            git push
            echo "üöÄ Altera√ß√µes sincronizadas com sucesso para o reposit√≥rio nexie-clean-core."
          else
            echo "‚úÖ Reposit√≥rio nexie-clean-core j√° est√° atualizado. Nenhuma a√ß√£o necess√°ria."
          fi